{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "AWS CloudFormation Template creating Policy, Role and user for remotely stop or starting instances and checking status.",

  "Resources" : {
    "CFNUser" : {
      "Type": "AWS::IAM::User",
      "Properties": {
        "UserName": "CloudControliOS"
      }
    },

    "CFNUserPolicies" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyName" : "StatusStopStartInstances",
        "PolicyDocument" : {
          "Version": "2012-10-17",
          "Statement": [
              {
                  "Sid": "VisualEditor0",
                  "Effect": "Allow",
                  "Action": [
                      "ec2:StartInstances",
                      "execute-api:Invoke",
                      "ec2:StopInstances"
                  ],
                  "Resource": [
                      "arn:aws:execute-api:*:*:*",
                      "arn:aws:ec2:*:*:instance/*"
                  ]
              },
              {
                  "Sid": "VisualEditor1",
                  "Effect": "Allow",
                  "Action": [
                      "ec2:DescribeInstances",
                      "ec2:DescribeRegions",
                      "ec2:DescribeInstanceStatus"
                  ],
                  "Resource": "*"
              }
          ]
      },
        "Users" : [{ "Ref" : "CFNUser" }],
        "Roles" : [{ "Ref" : "CFNRole" }]
      }
    },

    "CFNRole" : {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": "StatusStopStartInstances",
        "AssumeRolePolicyDocument": {
            "Version" : "2012-10-17",
            "Statement": [ {
               "Effect": "Allow",
               "Principal": {
                  "Service": [ "ec2.amazonaws.com" ]
               },
               "Action": [ "sts:AssumeRole" ]
            } ]
         }
      }
  },

  "CFNKeys" : {
      "Type" : "AWS::IAM::AccessKey",
      "Properties" : {
        "UserName" : { "Ref": "CFNUser" }
      }
    }
  },

  "Outputs" : {
    "AccessKey" : {
      "Value" : { "Ref" : "CFNKeys" },
      "Description" : "AWSAccessKeyId of new user"
    },
    "SecretKey" : {
      "Value" : { "Fn::GetAtt" : ["CFNKeys", "SecretAccessKey"]},
      "Description" : "AWSSecretKey of new user"
    }
  }

  "VPNGetInstances": {
    "Type": "AWS::Lambda::Function",
    "Properties": {
      "Handler": "index.handler",
      "Role": { "Fn::GetAtt" : ["CFNRole", "Arn"] },
      "Code": {
        "ZipFile":  { "Fn::Join": ["", [
          "var response = require('cfn-response');",
          "exports.handler = function(event, context) {",
          "   var responseData = {Value: event.ResourceProperties.List};",
          "   responseData.Value.push(event.ResourceProperties.AppendedItem);",
          "   response.send(event, context, response.SUCCESS, responseData);",
          "};"
        ]]}
      },
      "Runtime": "python3.6",
      "Timeout": 60
    }
  }
}
